


BEGIN
  IF EXISTS (SELECT * FROM salles WHERE idCinema = idCinema AND id = idSalle) THEN
    IF NOT EXISTS (SELECT * FROM seances WHERE idSalle = idSalle AND idFilm = idFilm AND laDate = laDate) THEN
      SIGNAL SQLSTATE '45000'
      SET MESSAGE_TEXT = "Il existe déjà une séance pour ce film et cette salle à cette date !";
    ELSE 
     SIGNAL SQLSTATE '45000'
      SET MESSAGE_TEXT = "Il existe pas ";
      # INSERT INTO seances (id, idFilm, idCinema, idSalle, laDate, heure) VALUES (NULL, idFilm, idCinema, idSalle, laDate, heure);
    END IF;
  ELSE
    SIGNAL SQLSTATE '45000'
    SET MESSAGE_TEXT = "La salle n'est pas dans le cinéma que vous avez déclaré !";
  END IF;
END


BEGIN
    IF EXISTS (SELECT * FROM seances WHERE idSalle = idSalle AND idFilm = idFilm AND laDate = laDate) THEN
      SIGNAL SQLSTATE '45000'
      SET MESSAGE_TEXT = "Il existe déjà une séance pour ce film et cette salle à cette date !";
    ELSE 
     SIGNAL SQLSTATE '45000'
      SET MESSAGE_TEXT = "Il existe pas ";
      # INSERT INTO seances (id, idFilm, idCinema, idSalle, laDate, heure) VALUES (NULL, idFilm, idCinema, idSalle, laDate, heure);
    END IF;
END

BEGIN
    DECLARE trouve_seance INT DEFAULT 0;
    SET trouve_seance = (SELECT COUNT(*) FROM seances WHERE idSalle = idSalle AND idFilm = idFilm AND laDate = laDate);
    IF trouve_seance > 0 THEN
      SIGNAL SQLSTATE '45000'
      SET MESSAGE_TEXT = "Il existe déjà une séance pour ce film et cette salle à cette date !";
    ELSE 
      SIGNAL SQLSTATE '45000'
      SET MESSAGE_TEXT = "Il existe pas ";
      # INSERT INTO seances (id, idFilm, idCinema, idSalle, laDate, heure) VALUES (NULL, idFilm, idCinema, idSalle, laDate, heure);
    END IF;
END


BEGIN
    DECLARE trouve_seance INT DEFAULT 0;
    SET trouve_seance = (SELECT COUNT(*) FROM seances WHERE idSalle = idSalle AND idFilm = idFilm AND laDate = laDate);
    RETURN trouve_seance
END



BEGIN
    DECLARE trouve_seance INT;
    SELECT COUNT(*) INTO trouve_seance FROM seances WHERE idSalle = idSalle AND idFilm = idFilm AND laDate = laDate  LIMIT 1;
    IF trouve_seance > 1 THEN
      SIGNAL SQLSTATE '45000'
      SET MESSAGE_TEXT = "Il existe déjà une séance pour ce film et cette salle à cette date !";
    ELSE 
      SIGNAL SQLSTATE '45000'
      SET MESSAGE_TEXT = "Il existe pas ";
      # INSERT INTO seances (id, idFilm, idCinema, idSalle, laDate, heure) VALUES (NULL, idFilm, idCinema, idSalle, laDate, heure);
    END IF;
END


BEGIN
    DECLARE ID_SALLE INT;
    DECLARE ID_FILM INT;
    DECLARE ID_CINEMA INT;

    SELECT *
    INTO ID_CINEMA, ID_SALLE
    FROM salles
    INNER JOIN cinema ON cinema.ID = salles.idCinema
    WHERE salles.nom = nom AND cinema.nom = nom
    LIMIT 1;
END

BEGIN

    SELECT INTO trouve_seance FROM seances WHERE idSalle = idSalle AND idFilm = idFilm LIMIT 1;
        IF trouve_seance > 1 THEN
            SIGNAL SQLSTATE '45000'
            SET MESSAGE_TEXT = "Il existe déjà une séance pour ce film et cette salle à cette date !"; 
            SET MESSAGE_TEXT = trouve_seance;
    ELSE 
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = "Il existe pas ";
        # INSERT INTO seances (id, idFilm, idCinema, idSalle, laDate, heure) VALUES (NULL, idFilm, idCinema, idSalle, laDate, heure);
    END IF;
END

BEGIN

    DECLARE trouve_seance INT;
    SELECT * INTO trouve_seance FROM seances WHERE `idSalle` = idSalle AND `idFilm` = idFilm;
    IF trouve_seance > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = "Il existe déjà une séance pour ce film et cette salle à cette date !";
    ELSE 
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = "Il existe pas ";
        # INSERT INTO seances (id, idFilm, idCinema, idSalle, laDate, heure) VALUES (NULL, idFilm, idCinema, idSalle, laDate, heure);
    END IF;
END


BEGIN
    DECLARE trouve_seance INT;
    SELECT COUNT(*) INTO trouve_seance FROM seances WHERE idSalle = idSalle AND idFilm = idFilm AND laDate = laDate;
    IF trouve_seance > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = "Il existe déjà une séance pour ce film et cette salle à cette date !";
    END IF;
END


DELIMITER $$
CREATE DEFINER=`root`@`localhost` PROCEDURE `ajouter_seances`(IN `idFIlm` INT, IN `idCinema` INT, IN `idSalle` INT, IN `laDate` DATE, IN `heure` INT)
BEGIN
    DECLARE trouve_seance INT;
    SET trouve_seance = (SELECT COUNT(*) FROM seances WHERE idSalle = idSalle AND idFilm = idFilm AND laDate = laDate);
    IF trouve_seance > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = "Il existe déjà une séance pour ce film et cette salle à cette date !";
    END IF;
END$$
DELIMITER ;


BEGIN
    DECLARE trouve_seance INT;
    SELECT COUNT(*) INTO trouve_seance FROM seances WHERE idSalle = idSalle AND idFilm = idFilm AND laDate = laDate;
    IF trouve_seance > 0 THEN
        SIGNAL SQLSTATE '45000'
        SET MESSAGE_TEXT = "Il existe déjà une séance pour ce film et cette salle à cette date !";
    END IF;
END

BEGIN
    DECLARE @idSalle INT;
    DECLARE @idFilm INT;
    SELECT COUNT(*) INTO trouve_seance FROM seances WHERE idSalle = @idSalle AND idFilm = @idFilm ;
END 


BEGIN
  -- Vérifie que la salle appartient bien à ce cinéma
  IF NOT EXISTS (
    SELECT 1
    FROM salles
    WHERE idCinema = idCinema AND idSalle = idSalle
  ) THEN
    SIGNAL SQLSTATE '45000'
    SET MESSAGE_TEXT = 'La salle ne fait pas partie du cinéma choisi';
  END IF;

  -- Vérifie qu'il n'y a pas de concurrence avec une autre séance dans la même salle
  IF EXISTS (
    SELECT 1
    FROM seances
    WHERE idSalle = idSalle AND heure = heure
  ) THEN
    SIGNAL SQLSTATE '45000'
    SET MESSAGE_TEXT = 'Une séance est déjà programmée dans cette salle à cette heure';
  END IF;

  -- Insère la séance si tout est valide
  INSERT INTO seances (idFilm, idCinema, idSalle, laDate, heure)
  VALUES (idFilm, idCinema, idSalle, laDate, heure);
END

BEGIN
  -- Vérifie qu'il n'y a pas de concurrence avec une autre séance dans la même salle
  IF EXISTS (
    SELECT 1
    FROM seances
    WHERE idSalle = idSalle AND heure = heure
  ) THEN
    SIGNAL SQLSTATE '45000'
    SET MESSAGE_TEXT = 'Une séance est déjà programmée dans cette salle à cette heure';
  END IF;
END